{{define "title"}}
{{tr .t "nav.api_statistics"}}
{{end}}

{{define "top_css"}}
<style>
    .stat-card {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid;
    }
    body.dark-mode .stat-card {
        background-color: #2a2a2a;
        border-color: #444;
    }
    body.light-mode .stat-card {
        background-color: #ffffff;
        border-color: #dee2e6;
    }
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #4e73df;
    }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
{{tr .t "api_stats.page_title"}}
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- Statistics Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>{{tr .t "api_stats.total_keys"}}</h5>
                    <div class="stat-number" id="stat_total_keys">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>{{tr .t "api_stats.active_keys"}}</h5>
                    <div class="stat-number" id="stat_active_keys">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>{{tr .t "api_stats.total_calls"}}</h5>
                    <div class="stat-number" id="stat_total_calls">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>{{tr .t "api_stats.calls_today"}}</h5>
                    <div class="stat-number" id="stat_calls_today">0</div>
                </div>
            </div>
        </div>

        <!-- Access Logs Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{tr .t "api_stats.logs_card_title"}}</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadStatistics()">
                                <i class="fas fa-sync"></i> {{tr .t "api_stats.refresh_button"}}
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="logs-table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>{{tr .t "api_stats.table_timestamp"}}</th>
                                    <th>{{tr .t "api_stats.table_api_key"}}</th>
                                    <th>{{tr .t "api_stats.table_method"}}</th>
                                    <th>{{tr .t "api_stats.table_endpoint"}}</th>
                                    <th>{{tr .t "api_stats.table_ip_address"}}</th>
                                    <th>{{tr .t "api_stats.table_user_agent"}}</th>
                                    <th>{{tr .t "api_stats.table_status"}}</th>
                                </tr>
                            </thead>
                            <tbody id="logs-list">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key Usage Chart -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{tr .t "api_stats.usage_chart_title"}}</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="usage-chart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{{end}}

{{define "bottom_js"}}
<script>
    let statsData = null;
    let usageChart = null;

    function loadStatistics() {
        $.ajax({
            url: '{{.basePath}}/api/api-statistics',
            type: 'GET',
            success: function(data) {
                statsData = data;
                renderStatistics();
            },
            error: function() {
                toastr.error('Failed to load API statistics');
            }
        });
    }

    function renderStatistics() {
        if (!statsData) return;

        // Update stat cards
        const totalKeys = statsData.api_keys ? statsData.api_keys.length : 0;
        const activeKeys = statsData.api_keys ? statsData.api_keys.filter(k => k.enabled).length : 0;
        const totalCalls = statsData.log_count || 0;

        $('#stat_total_keys').text(totalKeys);
        $('#stat_active_keys').text(activeKeys);
        $('#stat_total_calls').text(totalCalls);

        // Calculate calls today
        const today = new Date().toDateString();
        const callsToday = statsData.logs ? statsData.logs.filter(log => 
            new Date(log.timestamp).toDateString() === today
        ).length : 0;
        $('#stat_calls_today').text(callsToday);

        // Render logs table
        renderLogsTable();

        // Render usage chart
        renderUsageChart();
    }

    function renderLogsTable() {
        const tbody = $('#logs-list');
        tbody.empty();

        if (!statsData.logs || statsData.logs.length === 0) {
            tbody.append('<tr><td colspan="7" class="text-center">{{tr .t "api_stats.no_logs"}}</td></tr>');
            return;
        }

        // Show only the 100 most recent logs in the table
        const recentLogs = statsData.logs.slice(0, 100);

        recentLogs.forEach(function(log) {
            const statusBadge = log.status_code >= 200 && log.status_code < 300
                ? `<span class="badge badge-success">${log.status_code}</span>`
                : log.status_code >= 400
                ? `<span class="badge badge-danger">${log.status_code}</span>`
                : `<span class="badge badge-warning">${log.status_code}</span>`;

            const row = `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${escapeHtml(log.api_key_name)}</td>
                    <td><span class="badge badge-secondary">${escapeHtml(log.method)}</span></td>
                    <td><code>${escapeHtml(log.endpoint)}</code></td>
                    <td>${escapeHtml(log.ip_address)}</td>
                    <td>${escapeHtml((log.user_agent || '').substring(0, 50))}${(log.user_agent && log.user_agent.length > 50) ? '...' : ''}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function renderUsageChart() {
        // Count API calls by key
        const usageByKey = {};
        if (statsData.logs) {
            statsData.logs.forEach(function(log) {
                const keyName = log.api_key_name || 'Unknown';
                usageByKey[keyName] = (usageByKey[keyName] || 0) + 1;
            });
        }

        const labels = Object.keys(usageByKey);
        const data = Object.values(usageByKey);

        // Destroy existing chart if it exists
        if (usageChart) {
            usageChart.destroy();
        }

        // Create new chart
        const ctx = document.getElementById('usage-chart').getContext('2d');
        usageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{tr .t "api_stats.chart_label"}}',
                    data: data,
                    backgroundColor: '#4e73df',
                    borderColor: '#2e59d9',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    $(document).ready(function() {
        loadStatistics();
        // Refresh every 30 seconds
        setInterval(loadStatistics, 30000);
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{{end}}

{{template "base.html" .}}
